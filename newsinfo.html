<html>

<head>
    <title>Title</title>
    <link rel="stylesheet" href="/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="/css/list.css">
    <style>
    body {
        /*overflow-y: scroll;*/
    }

    .layui-body {
        overflow-y: scroll;
    }
    </style>
</head>

<body>
    <div id="formEdit" style="padding:20px;">
        <form class="layui-form layui-form-pane" action="" lay-filter="">
            <div class="layui-form-item">
                <label class="layui-form-label">标题</label>
                <div class="layui-input-block">
                    <input type="text" id="title" name="title" lay-verify="required" autocomplete="off" placeholder="请输入标题" class="layui-input">
                </div>
            </div>
            <!-- <div class="layui-form-item">
                  <label class="layui-form-label">排序</label>
                  <div class="layui-input-block">
                      <input type="number" id="sort" name="sort" lay-verify="required|number" autocomplete="off" placeholder="请输入排序" class="layui-input">
                  </div>
              </div> -->
            <div class="layui-form-item">
                <label class="layui-form-label">置顶</label>
                <div class="layui-input-block">
                    <input type="checkbox" id="top" lay-skin="switch" lay-text="ON|OFF" lay-filter="switchTest" value="0">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">是否上架</label>
                <div class="layui-input-block">
                    <input type="checkbox" id="status" lay-skin="switch" lay-text="ON|OFF" lay-filter="switchTest" value="1" checked>
                </div>
            </div>
            <div class="layui-form-item j_select">
                <label class="layui-form-label">选择</label>
                <div class="layui-input-block">
                    <input type="radio" class="type_edit" name="type" value="1" title="站外链接" checked="">
                    <input type="radio" class="type_edit" name="type" value="2" title="站内编辑" disabled="disabled">
                </div>
            </div>
            <div class="layui-form-item j_selectGroup">
                <label class="layui-form-label">站外链接</label>
                <div class="layui-input-block">
                    <input type="text" id="link" name="url" lay-verify="url" autocomplete="off" placeholder="请输入链接" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item j_selectGroup" style="display:none;">
                <label class="layui-form-label">站内编辑</label>
                <div class="layui-input-block">
                    <textarea placeholder="请输入内容" class="layui-textarea"></textarea>
                </div>
            </div>
            <div class="layui-form-item j_select1">
                <label class="layui-form-label">选择关联</label>
                <div class="layui-input-block">
                    <input type="radio" class="detailType" name="detailType" value="0" title="无" checked="">
                    <input type="radio" class="detailType" name="detailType" value="1" title="关联联赛">
                    <input type="radio" class="detailType" name="detailType" value="2" title="关联比赛">
                </div>
            </div>
            <div class="layui-form-item j_selectGroup1" style="display:none;">
                <label class="layui-form-label">关联联赛</label>
                <div class="layui-input-inline j_lx">
                    <div class="layui-unselect layui-form-select">
                        <div class="layui-select-title">
                            <input type="text" placeholder="请选择赛事" value="" class="j_selectInput layui-input layui-unselect"><i class="layui-edge"></i>
                        </div>
                        <dl class="layui-anim layui-anim-upbit" style="">
                            <dd lay-value="" class="layui-select-tips">请选择赛事</dd>
                        </dl>
                    </div>
                </div>
            </div>
            <div class="layui-form-item j_selectGroup1" style="display:none;">
                <label class="layui-form-label">关联比赛</label>
                <div class="layui-input-inline j_category1">
                    <div class="layui-unselect layui-form-select">
                        <div class="layui-select-title">
                            <input type="text" placeholder="请选择赛事" value="" class="j_selectInput layui-input layui-unselect"><i class="layui-edge"></i>
                        </div>
                        <dl class="layui-anim layui-anim-upbit" style="">
                            <dd lay-value="" class="layui-select-tips">请选择赛事</dd>
                        </dl>
                    </div>
                </div>
                <div class="layui-input-inline j_category2">
                    <div class="layui-unselect layui-form-select">
                        <div class="layui-select-title">
                            <input type="text" placeholder="请选择赛制" value="" class="j_selectInput layui-input layui-unselect"><i class="layui-edge"></i>
                        </div>
                        <dl class="layui-anim layui-anim-upbit" style="">
                            <dd lay-value="" class="layui-select-tips">请选择赛制</dd>
                        </dl>
                    </div>
                </div>
                <div class="layui-input-inline j_category3">
                    <div class="layui-unselect layui-form-select">
                        <div class="layui-select-title">
                            <input type="text" placeholder="请选择分组" value="" class="j_selectInput layui-input layui-unselect"><i class="layui-edge"></i>
                        </div>
                        <dl class="layui-anim layui-anim-upbit" style="">
                            <dd lay-value="" class="layui-select-tips">请选择分组</dd>
                        </dl>
                    </div>
                </div>
                <div class="layui-input-inline j_category4">
                    <div class="layui-unselect layui-form-select">
                        <div class="layui-select-title">
                            <input type="text" placeholder="请选择比赛" value="" class="j_selectInput layui-input layui-unselect"><i class="layui-edge"></i>
                        </div>
                        <dl class="layui-anim layui-anim-upbit" style="">
                            <dd lay-value="" class="layui-select-tips">请选择比赛</dd>
                        </dl>
                    </div>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">上传图片</label>
                <div class="layui-input-block">
                    <input type="hidden" name="sysStgDataId" id="banner" lay-verify="photo">
                    <button type="button" class="layui-btn" id="logo">上传图片</button>
                    <div>
                        <img class="layui-upload-img" id="img1" width="80">
                    </div>
                </div>
            </div>
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">生效时间</label>
                    <div class="layui-input-block">
                        <input type="text" name="releaseTime" id="beginTime" lay-verify="required|datetime" placeholder="" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">失效时间</label>
                    <div class="layui-input-block">
                        <input type="text" name="endTime" id="endTime" lay-verify="datetime|endTime" placeholder="" autocomplete="off" class="layui-input">
                    </div>
                </div>
            </div>
            <div class="layui-form-item">
                <div class="layui-input-block">
                    <button class="layui-btn" lay-submit="" lay-filter="btnSubmit">立即提交</button>
                    <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                </div>
            </div>
        </form>
    </div>
    <script type="text/html" id="imgTpl">
        <img src="{{d.image}}" alt="" style="max-width:100%;max-height:100%;">
    </script>
    <!-- 模板文件 end-->
    <script src="/layui/layui.js" charset="utf-8"></script>
    <script type="text/javascript" src="/js/util.js"></script>
    <script>
    var dev = '',
        prod = '/',
        status = layui.data('test').status,
        proNewsId = '88998899';
    var address = dev;
    layui.extend({
        select_Category: "/js/select.jquery"
    }).use(['select_Category', 'laydate', 'form', 'laypage', 'layer', 'table', 'carousel', 'upload', 'element', 'layedit'], function() {
        var laydate = layui.laydate,
            form = layui.form,
            laypage = layui.laypage,
            layer = layui.layer,
            table = layui.table,
            carousel = layui.carousel,
            upload = layui.upload,
            $ = layui.jquery,
            element = layui.element,
            select_Category = layui.select_Category,
            layedit = layui.layedit;
        ~(function() {
            //三级联动
            var _config1 = {
                Category1ID: "j_category1",
                Category2ID: "j_category2",
                Category3ID: "j_category3",
                Category4ID: "j_category4",
                DataURL: address + '/data/select_RelationMatch.json'
            }
            if (proNewsId && status == 'edit') {
                _config1.state = 'edit';
                $('[type=reset]').hide();
                setHidden('proNewsId', proNewsId);
                $.get('/data/select_newsInfo.json', { 'proNewsId': proNewsId }, function(result) {
                    var data = result.data.ProNews;
                    $("#title").val(data.title);
                    $("#link").val(data.url);
                    $("#beginTime").val(data.releaseTime);
                    $("#endTime").val(data.endTime);
                    $("#img1").attr("src", data.banner);
                    var top = $('#top');
                    data.top.value == 1 ?
                        top.attr("checked", "checked") :
                        top.removeAttr("checked");
                    var status = $('#status');
                    data.status.value == 1 ?
                        status.attr("checked", "checked") :
                        status.removeAttr("checked");
                    // $('.state_edit[value='+data.status.value+']').attr('checked',true)
                    $('.type_edit[value=' + data.type.value + ']').attr('checked', true)
                    $('.detailType[value=' + data.detailType.value + ']').attr('checked', true)
                    if (data.detailType.value == 1) {
                        var current = $('.j_selectGroup1').eq(data.detailType.value - 1).show();
                        loadSaishi(data.handler, function(val) {
                            current.find('.layui-input').val(val)
                        })
                        current.siblings('.j_selectGroup1').hide();
                        setHidden('handler', data.handler)
                    } else if (data.detailType.value == 2) {
                        $('.j_selectGroup1').eq(data.detailType.value - 1).show().siblings('.j_selectGroup1').hide();
                        setHidden('handler', data.id)
                        select_Category(_config1, {
                            activityId: data.activityId,
                            eventId: data.eventId,
                            groupId: data.groupId,
                            id: data.id
                        }, function(obj) {
                            $('.j_category1 .layui-input').val(obj.val1);
                            $('.j_category2 .layui-input').val(obj.val2)
                            $('.j_category3 .layui-input').val(obj.val3)
                            $('.j_category4 .layui-input').val(obj.val4)
                        });
                    }
                    form.render('radio')
                    form.render('checkbox')
                }, 'json');
            } else {
                $('#beginTime').val(zgs_util.getNowFormatDate());
            }
            upload.render({
                elem: '#logo',
                accept: 'images',
                size: 1024,
                field: 'photo',
                data: {
                    stgFileType: 7
                },
                url: '/data/upload_img.json',
                // ,auto: false
                before: function(obj) {
                    //预读本地文件示例，不支持ie8
                    obj.preview(function(index, file, result) {
                        $('#img1').attr('src', result); //图片链接（base64）
                    });
                },
                // ,bindAction: '#img1'
                done: function(res) {
                    if (res.status == 1) {
                        $('#banner').val(res.data.sysStgDataId)
                    } else {
                        zgs_util.layerErr(res.msg)
                    }
                }
            });
            //日期
            laydate.render({
                elem: '#beginTime',
                type: 'datetime'
            });
            laydate.render({
                elem: '#endTime',
                type: 'datetime'
            });
            //自定义验证规则
            form.verify({
                endTime: function(value) {
                    if (value && value < $('#beginTime').val()) {
                        return '失效时间不能小于开始时间';
                    }
                },
                photo: function(value) {
                    if (!value && !$('#img1').attr('src')) {
                        return '请上传新闻图片'
                    }
                },
                handler: function(value) {
                    if (value == "" && $('.detailType:checked').val() != 0) {
                        return '请选择要关联的联赛'
                    }
                }
            })

            $('.j_select').on('click', '.layui-form-radio', function() {
                if ($(this).is('.layui-disabled')) {
                    return;
                }
                var index = $(this).index('.j_select .layui-form-radio');
                $('.j_selectGroup').eq(index).show().siblings('.j_selectGroup').hide();
            })
            $('.j_select1').on('click', '.layui-form-radio', function() {
                if ($(this).is('.layui-disabled')) {
                    return;
                }
                setHidden('handler', "")
                var index = $(this).index('.j_select1 .layui-form-radio');
                if (index == 0)
                    $('.j_selectGroup1').hide();
                else if (index == 1) {
                    callback();
                    loadSaishi()
                } else {
                    callback();
                    _config1.state = 'create';
                    select_Category(_config1);
                }

                function callback() {
                    var current = $('.j_selectGroup1').eq(index - 1).show();
                    current.find('.layui-input').val('');
                    current.siblings('.j_selectGroup1').hide();
                }

            })
            var oldStyle;
            $('.j_selectInput').on('input', function() {
                searchList($(this))
            })
            $('.layui-input').on('click', function(ev) {
                $(this).parents('.layui-form-select').toggleClass('layui-form-selected')
            })
            $('.j_lx').on('click', 'dd', function(ev) {
                ev.stopPropagation();
                if (!$(this).attr('lay-value') || $(this).attr('lay-value') == "") {
                    window.top.open_layer('联赛不能为空', { 'icon': 5, 'anim': 6 });
                    return false;
                }
                oldStyle ? $(oldStyle).removeClass('layui-this') : $(this).siblings('.layui-this').removeClass('layui-this');
                $(this).addClass('layui-this');
                $('.j_lx .layui-input').val($(this).text());
                setHidden('handler', $(this).attr('lay-value'))
                oldStyle = this;
                $('.layui-form-select').removeClass('layui-form-selected');
            });
            //监听指定开关
            form.on('switch(switchTest)', function(data) {
                $(this).val(this.checked ? 1 : 0)
            });
            //监听提交
            form.on('submit(btnSubmit)', function(data) {
                var obj = data.field;
                var data = new FormData();
                data.append('top', $('#top').prop('checked') ? 1 : 0);
                data.append('status', $('#status').prop('checked') ? 1 : 0);
                for (var k in obj) {
                    if (k == 'photo') continue;
                    if (k == 'sysStgDataId' && !obj[k]) continue;
                    data.append(k, obj[k]);
                }
                if (status == 'add') {
                    ajax_submit("/data/submit.json", data, 'add')
                } else if (status == 'edit') {
                    ajax_submit("/data/submit.json", data, 'edit')
                }
                return false;
            });

            function searchList(input) {
                var val = input.val();
                var lists = input.parent().siblings('dl');
                var list = lists.children('dd');
                var len = 0;
                list.each(function(index, element) {
                    var _text = $(this).text();
                    if (_text.toLowerCase().indexOf(val.toLowerCase()) != -1) {
                        len++;
                        $(this).removeClass('layui-hide')
                    } else {
                        $(this).addClass('layui-hide');
                    }
                })
                if (len == 0) {
                    lists.find('p').length <= 0 && lists.append('<p class="layui-select-none">无匹配项</p>');
                } else {
                    lists.children('p').remove();
                }
            }

            function ajax_submit(url, data, state) {
                $.ajax({
                    url: url,
                    type: "get",
                    processData: false,
                    contentType: false,
                    data: data,
                    // dataType: 'json',
                    success: state == 'add' ? zgs_util.addSuccess : zgs_util.updSuccess,
                    error: zgs_util.error
                });
            }

            function loadSaishi(id, callback) {
                $.get(address + '/data/select_RelationMatch.json', '', function(result) {
                    var data = result.data;
                    var _arr = ['<dd lay-value="" class="layui-select-tips">请选择赛事</dd>'];
                    for (var i = 0, len = data.length; i < len; i++) {
                        var _class = "";
                        if (id && id == data[i].id && callback) {
                            if (data[i].id == id) {
                                _class = "class='layui-this'";
                            }
                            callback(data[i].name)
                        } else if (!id && i == 0) {
                            _class = "class='layui-this'";
                        }
                        _arr.push(" <dd lay-value='" + data[i].id + "' " + _class + ">" + data[i].name + "</dd>");
                    }
                    $(".j_lx").find('dl').html(_arr.join(''));
                }, "json")
            }

            function setHidden(element, val) {
                var _current = $('#' + element);
                _current.length <= 0 ?
                    $('.layui-form').append('<input type="hidden" id="' + element + '" name="' + element + '" value="' + val + '" lay-verify="' + element + '"/>') :
                    _current.val(val);
            }
        })()
    });
    </script>
</body>

</html>